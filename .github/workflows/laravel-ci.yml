name: Laravel

on:
  push:
    branches: [ master, github-action ]
    tags: [ 'v1.0.0' ]
  pull_request:
    branches: [ master, github-action ]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify Docker installation
      run: |
        docker --version
        docker compose version
    - name: Create .env file
      run: |
        echo "ADMINER_DEFAULT_SERVER=db" >> .env
        echo "DB_HOST=db" >> .env
        echo "DB_PORT=3306" >> .env
        echo "DB_DATABASE=laravel" >> .env
        echo "DB_USERNAME=root" >> .env
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
        
    - name: Cache Composer dependencies
      uses: actions/cache@v3
      with:
        path: vendor
        key: composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: composer-

    - name: Start Docker containers
      run: docker compose up -d --build

    - name: Install Dependencies
      run: docker compose exec -T backend composer install --no-ansi --no-interaction --optimize-autoloader

    - name: Generate key
      run: docker compose exec -T backend php artisan key:generate

    - name: Run Tests
      run: docker compose exec -T backend php artisan test

    - name: Show Docker logs on failure
      if: failure()
      run: docker compose logs

    - name: Stop Docker containers
      run: docker compose down
      if: always()

    - name: Notify on failure
      if: failure()
      uses: slackapi/slack-github-action@v1.27.0
      with:
        slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
        channel-id: 'github'
        text: 'Laravel CI failed for ${{ github.repository }} on ${{ github.ref }}'